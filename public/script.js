// Sample music data for different moods
const moodMusic = {
    happy: [
        { 
            title: "Here With Me", 
            artist: "d4vd", 
            duration: "4:02", 
            file: "songs/Here With Me.mp3",
            novel: `十三岁那年，婆婆教我如何腌制记忆。
"就像腌黄瓜、萝卜、卷心菜，"她说，"切成方块。记忆像苹果一样，一刀下去，咔哒一声。"

我把它们浸进盐、糖、醋和水的混合液。加点香料会让味道变形，也更难以下咽。
"这是家族秘方，"她说，"让你能够遗忘。"

"忘记什么？"我问。
"任何事。我们家的女人天生难以忘记，所以我们有这些罐子。"

一开始，我们从小事练手：
（1）在学校更衣室掉了内裤被全班看到；
（2）在超市拉住一个陌生女人的裙子，以为她是妈妈；
（3）反复梦见自己被困在一栋废弃大楼里，出不去。

拧紧盖子后，她问我："感觉如何？"
感觉像是在不停咬紧又松开下颌。紧绷与释然交替。我只是耸了耸肩，没有说我既满又空。

她从不问他是否还会回来，只在独处时为他祈祷。她向他问晚饭想吃什么，也祈愿生意顺利。他们之间有种沉默，安静又持久，是双方都接受的沉默。

他来回奔波于旧金山与中国南方。拥有一个浑身带着太平洋咸味的丈夫，是稀罕的。一个几乎全由盐组成的人，更是稀罕。

我是婆婆女儿的女儿，但我和她之间的咸水纽带比血缘更深。我母亲对此不以为然："妈，你教她这些干嘛？"

"因为你不会教，"婆婆说。

我问母亲："你有自己的罐子吗？"
她说没有。我曾找过，一无所获。
"那不是真的，"婆婆说，"你小时候也做过几罐。"

母亲沉默了，她低头整理一张早餐用过的纸巾，指尖缓慢抚平褶皱。
"我受够了，"她撕碎纸巾，"为什么你要决定我们该记得什么、忘了什么？"她眼里有泪。我想帮她擦去，却害怕她的泪不是咸的，怕她不是由盐做的。

"妈，"她说，"我什么都记得。"

我放学回家时，母亲把我的记忆罐全摆在厨房台面上。
她坐我下来，说："记忆即使痛苦也重要。我担心你，也担心你婆婆。"

"我没事，婆婆也没事。"
"她真的没事吗？她开始忘事，错过约定，有时候连早饭吃了什么都不记得。"

我望着那些罐子，液体浑浊发灰。我想打开看看里面装了什么，又想摔碎它们，看记忆溅落一地。

"你真的什么都记得？"我问她。
"没有人什么都记得，"她说。
"可你对婆婆说——"
"我当时只是气话。"

"那你讲一个故事给我听。"

她说了很多：
婆婆为外公归家准备他爱吃的冬瓜汤、咸水鸭；穿粉色裙子，因为外公厌倦了海的蓝绿；白色棉被摸起来像天鹅绒；外公出差时，母亲总与婆婆同床入睡。

母亲和父亲原是婚外情，在萨克拉门托一家保险公司工作时相识。他们深爱彼此，爱到她不觉得饥饿。父亲离开后，她吃光了冰箱和橱柜里的所有食物。

故事支离破碎，有些记得，有些找不着。她问我感觉如何，我没告诉她，其实感觉一样——紧绷又松弛，饱满又空虚。

有了我以后，婆婆不再孤单。她牵着我穿越唐人街，不再怕被风吹走。她教我用英文说"苹果""积木"，却从不跟我讲粤语。不会用英文表达时，她选择沉默。

我长大后，把更多东西腌进罐子里。那感觉像是解脱之外更大的释放。
我倒掉果酱、美乃滋和花生酱，堵住水槽，把自己塞进空罐子里。

（1）我忘了第一次做爱时播放的歌曲，那男孩换完床单便离开；
（2）我忘了那个白人女子对我说："你长得更漂亮，因为你不是纯华裔"，并摸了我的头发；
（3）我忘了走在街上被男人盯着的视线，还有那个说"我从没碰过像你这样的人"的家伙；
（4）我忘了母亲癌症晚期时的模样；
（5）我忘了车上那个对我说粤语的老妇人，而我一句也回不了口。

婆婆从未提醒我别让这变成习惯。母亲也不在了，没有人再帮我计数，或提醒我这些我本不该忘记的东西。

他决定临终前回中国。"我不能死在这里。"
"你要丢下我？"她问。
"是。"

"那我怎么办？还有Anne呢？"
"我终究是要死的。你不想我的鬼魂缠着你吧？"

她忍痛说："你说得对。"

为避免被他的灵魂纠缠，她把他的大部分记忆封进三十七个玻璃罐。只留下足以讲述给孙辈的五样：名字、职业、出生地、死亡地，以及他那口咸咸的呼吸。

没有院子埋藏剩余记忆，她把它们塞到床底。第一晚就听到持续的嗡嗡声。她学会与那声音共处，直到不再察觉它的存在。

"Anne，帮我拿量杯。"她有天说。
"婆婆，我是Katie。Anne是我妈。"她皱起眉头，自己去拿量杯。她的记忆衰退愈加严重。

"别再这样了，这只会让你更糟。"我说。她仍在称量、搅拌，舔了下食指，蘸盐尝了一口。

"我快完成了。"她说。

"完成什么？你还有什么要忘的？"我怒拍厨房台面，她的盐碗微微晃动。

我们沉默良久，她轻声说："我爱你，但我忘了怎么用另一种方式说。"

"什么意思？"我问。她脸上的泪看起来几乎是乳白色的。

"我曾用另一种话说'我爱你'，对一个人。你记得吗？"
"不记得了，婆婆。"

她抱着我时，从不肯松手。她说我的肌肤像我母亲小时候，但模样又截然不同。她怕放开我，我就会消失，再也找不回来。她不愿放手，因为这不是她能舍得的东西。

母亲去世七年后，婆婆终于彻底"溶解"。她的腌制过程加速了。我爱的东西一个个缩小、碎裂，从我指缝中滑落。

我不再难以遗忘，哪怕没有罐子。难的是记得——它让我彻夜难眠。

我收拾她的房子，试图找到她藏匿自己的地方。每一张椅子、每一件小物、每一本书我都摸遍。罐子藏在各处，甚至洗发水瓶、牙膏管里也藏着记忆。

我把它们全摆到客厅，地板不够就堆到沙发上、电视后。一瓶瓶打开：有些闻起来像腐臭的死亡，装的是她漂洋过海、移民初年、母亲去世的记忆；有些味道像海，像外公的咸味呼吸；而关于我的那些，闻起来像香草酸奶和草莓。

我躺在地板上，任液体浸湿衣服。如果她们在场，我会说：
（1）我依然渴望无法拥有的事物。
（2）我活在夹缝中，但没有撕裂。
（3）我们都快溺死在这片盐水里。`
        }
    ],
    sad: [
        {
            title: "跳楼机",
            artist: "利比",
            duration: "3:30",
            file: "songs/跳楼机.mp3",
            novel: `嘟——嘟——嘟！

一辆公交车像失控的野兽般在马路上横冲直撞，刺耳的喇叭声划破空气，令人心惊。先猛地向左一打，再急速甩向右边……开车的人似乎早已失去了对方向盘的掌控。速度不断攀升，车身摇摇欲坠，仿佛下一秒就会翻覆。其他车辆纷纷急刹避让。

公交车横穿了数条车道，最后猛地一拐，冲上了人行道。

"砰！"

随着一声巨响，它撞上了电线杆。那电杆应声倒下，狠狠砸在车顶。路人从各自的车中跑出，围到了事故现场。公交车门嘎吱一声打开，乘客们惊魂未定地纷纷逃出。

"快打119！"

"司机快不行了！"

2031年10月3日。

一位名叫韩马鲁的公交司机去世了，享年四十五岁。

"人生中，有什么遗憾吗？"

这是韩马鲁睁开眼后，脑海里冒出的第一个念头。他听见浪花轻拍岸边的声音，凉风拂面。他坐起身，打量四周。

这是哪里？

"你醒啦？我正准备叫你。"一个女人的声音从背后传来，令他更加迷惑。

"这里是……"他喃喃着。

幸好，那女人似乎早已预料到他会困惑。

"你很快就会知道了。闭上眼，想一想。"

当她这句话落下时，马鲁心中豁然开朗。他有些震惊于自己的顿悟，紧接着，脸上浮现出几分苦涩。

"所以我……死了？"他低声问。

女人轻轻点头，"没错。"

"你是……天使吗？"他带着疑惑看向她。

女人笑了笑，有些无奈地回答："可以这么说吧。有人叫我天使，也有人叫我死神……不过这些称呼并不重要，接下来要说的才是关键。"

女人迈开步子，朝前走去，步伐不急不缓。马鲁加快了点速度跟上她。大约走了一分钟，他们来到了一顶沙滩上唯一的遮阳伞前。

"请坐。"女人做了个手势。

马鲁顺势坐下，女人也落座后继续说道："韩先生，您是在2031年10月3日，上午11点23分14秒去世的。还记得当时的情形吗？"

"记得。"马鲁点头。

他回忆起那一幕，就像回想很久以前的梦。他当时正开车驶向终点站，忽然一个东西从天而降，直冲车前。他没能看清那是什么，只感觉胸口剧痛，那东西砸破挡风玻璃，撞到他胸前，随后滚落在他座位旁边。

他呼吸迅速变得困难，四肢也开始不听使唤。

马鲁强忍着痛意踩下刹车，猛地把车甩上了人行道——必须保证乘客们的安全。事到如今，那似乎是最明智的选择。然后……他什么都不记得了。再醒来，就是这个地方了。

他开口问道："乘客们……都没事吧？"

"多亏了你，所有人都活下来了。如果你中途放弃了，车会直接撞上一辆大货车，结局会惨不忍睹。"女人答道。

听到这个答复，马鲁松了一口气。"那就好。"

尽管如此，他还是死了。妻子怎么办？女儿怎么办？不过，忽然他想起自己似乎有买过保险。

"五亿韩元……够女儿撑到成年了吧？"

女人听后笑了笑，"你果然在想着家人呢。"

"是啊。女儿就快上高中啦。我以前总觉得对不起她，工资太低，没办法给她更好的生活……不过有了这笔钱……"他抹了把眼角。

"韩先生。"女人忽然开口。

"嗯？"

"如果有机会……你想重新活一次吗？"

马鲁一时语塞。

"什么？"

就在这时，一位身穿白色韩服的老妇从女人身后缓缓走出。马鲁认得她——住在他家隔壁的奶奶，靠捡废纸为生，姓柳，叫福子。

"母亲……"马鲁脱口而出。

她并非他的亲生母亲。但不知从什么时候起，他习惯了这么称呼她。

"柳奶奶决定把她的机会让给你。"女人轻声说。

"机会？什么机会？"马鲁越来越搞不懂了。

"重生的机会。"女人回答。

听到这，他仍觉得不可思议。老妇人走上前来，握住了他的手。

"托你的福，我晚年过得比以前好多了。你比我亲生儿女都更照顾我。"她那双布满皱纹的手温暖而坚定。马鲁回忆起自己常在冬天帮她推小推车的场景。他并不是为了回报才去帮忙，只是希望看到她笑一笑。

"您愿意把这机会让给我吗，母亲？"他颤声问道。

一旁的女人点了点头，"是的。"

"不行，母亲。我不配……"马鲁下意识摇头。

老妇人打断了他的话："我这一生已经够了。我不想再经历战争，也不想再逃亡了。这样安静地结束挺好。况且我那边的朋友们都等着我呢。"

她脸上浮现出淡然的笑意："可你不一样，马鲁。你还年轻，我不愿看你这样离开。就当是……我送给你的礼物吧，感谢你一直陪我说话。"

"母亲……"马鲁已泣不成声。

"请接受吧。"

话音落下，老妇人的身影渐渐淡去，化作光点，随风而逝。马鲁茫然地望向女人。

"当然，重来是有限制的。"她开口，"你不会完整保留前世的记忆，不能靠中彩票走捷径。"

"我真的能……重新开始吗？"

女人点头。他陷入沉思——如果能再活一次，会是什么样？

"那个……"他刚开口。

"你可以再见到现在的妻子。"女人率先替他解惑，"是否再次和她相遇，由你决定。而且，你还会拥有一些特别的'能力'。"

"能力？"马鲁好奇地问。是漫画里的那种能力？还是厨艺特别好那种？不过这次女人没打算再解释下去。

"把它当作你在前世带给别人幸福的回报吧。柳奶奶也为你留下了这份礼物。"

马鲁心头一动，第一次真正开始好奇——柳奶奶究竟是怎样的人？竟能做到如此。

女人似乎看穿了他的想法，"她是个用一生在默默善待世界的人。原本我也邀请她重生，但她把机会让给了你。"

女人摊开手掌，一粒小小的药丸静静地躺在她掌心。

"吃下它，你就会回到少年时光。"

"也就是说……"

"高中一年级。"她回答。

高中？马鲁对那段时光已经记不太清了。也许还有几个一直联系着的朋友？二十年过去，记忆早就模糊了。

"醒来后会想起一些的。"

马鲁接过药丸。女人微笑着望向他。

"请不要再那么拼命地讨好别人了。这份心意固然可贵，但你牺牲了太多。"

他轻轻一笑："我也没那么伟大啦。"

他最后看了一眼药丸，还在犹豫要不要真的回去。就在这时，一只布满皱纹的手突然出现，将药丸塞进了他的嘴里。

他惊讶地回头，看到那熟悉的慈祥笑容。

"这一次……请好好享受人生吧。"

他的意识，随之沉入黑暗。

很多人时常会想："要是能回到那个时候就好了……"等好不容易熬过升学考试，又得焦头烂额地找工作；等工作稍微稳定，又要应对上司的压迫；等到终于熬出头，孩子又要上大学了。

"早知道会这么累，为什么当年不好好玩一玩？为什么当年没更努力？为什么做了那个决定？"每天，或许有上千万的人都在为过去的选择感到后悔。

而韩马鲁——他得到了实现这种幻想的机会。

电脑风扇发出轻微的嗡嗡声。显示器还未打开，但主机依旧在运作。他看到墙上贴着一张小纸条——那是初中毕业时立下的新年目标？

"呼……"他坐起身，用手指揉着太阳穴。电热毯的热气直往臀部钻。

他轻笑了一声。这个小小的房间、随处乱扔的衣物、一角堆积如山的漫画书、图书馆借却没读的那本旧书、昨晚吃了一半的薯片、床边那只新书包，还有——

他在枕头底下摸索着。找到了。手机。他生前就有个习惯：睡觉前总把手机藏在枕头下。

"是高一吧……"他低声自语。

他滑开那部早已陌生的老式手机。"对了，这时候的手机是这个样子的。"但没过多久——

"后面是怎么变来着？"

他记得手机后来有变化，却怎么也想不起来了。

"原来如此……"马鲁明白了。

女人说得没错。他的记忆是不完整的。很多关于45岁那年的事情，他都记不清了，甚至不如昨天晚饭记得清楚。

"胖虎、长脚、龟头、鲑鱼、金眼……"

初中时朋友的外号却一个没落。他记得的关于45岁的唯一清晰的事，就是——他开的公交车是32路。但公司名字？完全记不得。

也许正因为如此，他醒来时并不慌乱？记忆没有打架，仿佛只是做了一场很长的梦——醒来后，那梦也变得模糊了。

但他记得清清楚楚：自己有个女儿，闻到他脚臭就会轻微抽搐；还有一个深爱他的妻子。

他抬头望向天花板。

"原来……真的回来了啊。"`
        }
    ],
    tired: [
        {
            title: "Luther",
            artist: "Kendrick",
            duration: "3:45",
            file: "songs/luther.mp3",
            novel: `你正要回家的路上，却在途中死去了。

那是一场车祸。平凡无奇，却足以致命。你留下了一位妻子和两个孩子。死亡来得迅速，没有痛苦。急救人员拼尽全力想救你，但为时已晚。你的身体几乎粉碎，走了其实对你而言是种解脱。请相信我。

就在那时，你遇见了我。

"什……什么情况？"你问道，"我在哪儿？"

"你死了。"我平静地说。没必要拐弯抹角。

"是……一辆卡车，它打滑了……"

"是的。"我说。

"我……真的死了？"

"是的。但别太难过。人人都会死。"我说。

你环顾四周，什么也没有。只有你和我。

"这是哪儿？"你问，"死后的世界？"

"差不多。"我说。

"你是……神？"你问。

"是的。"我答道，"我是神。"

"我的孩子……我的妻子……"你喃喃道。

"他们怎么了？"

"他们会没事吗？"

"这很好。"我说，"你刚刚离开尘世，第一反应却是关心家人。这很珍贵。"

你望着我，满眼疑惑。在你眼中，我不像神，更像是一个普通人，甚至可能是女性。没有威严，更像个小学教师，而不是全知全能的造物主。

"放心吧，"我说，"他们会好的。孩子们会以完美的形象记住你，他们还没来得及对你产生怨恨。你妻子会在外人面前哭泣，但内心深处其实松了口气。说实话，你们的婚姻已经走到了尽头。如果这能带来一丝安慰，她会因为这种轻松感而感到愧疚。"

"哦……"你轻声说道。"那现在呢？我会去天堂或者地狱吗？"

"都不会。"我说，"你会转世。"

"啊，是吗？那印度教是对的？"

"所有宗教在某种意义上都是对的。"我说，"和我走走吧。"

你跟着我，在虚无中并肩前行。

"我们去哪儿？"

"也没个具体方向。"我说，"只是边走边聊比较舒服。"

"那这究竟有什么意义？"你问，"如果我转世变成个婴儿，不就什么都忘了吗？这一生的经历岂不是白费？"

"并非如此。"我答道，"你内在拥有所有前世的记忆与经验，只是现在你不记得了。"

我停下脚步，双手轻放在你肩上。

"你的灵魂，比你想象中更宏伟、更美丽，也更浩瀚。人的大脑，只能承载你意识的极小一部分。就像用手指蘸水去感知冷热——你只是将一小部分的自我投入这具容器，当你抽回手指，所经历的一切，便归于你本身。"

"你已经在人世生活了48年，还未完全舒展那浩渺的自我。如果我们在这儿停留足够久，你就能想起一切。但在每次轮回之间，记忆并不重要。"

"那我到底轮回了多少次？"

"无数次。各种各样的生命形态。"我说，"这次，你将转世为公元540年的中国一位农家少女。"

"等一下，什么？"你惊呼，"你是说我要回到过去？"

"从你那边看，是回到过去。但时间，只是你所在宇宙中的概念。在我这边，运作方式不同。"

"你那边？"你问。

"当然。"我回答，"我来自另一个地方。而且，还有像我一样的存在。你可能会想知道那是什么样的世界，但说实话，你现在理解不了。"

"哦……"你有些失落。"等等，如果我会在不同时间转世，那我岂不是可能遇到过自己？"

"确实如此，经常会发生。但因为每段生命都只知自己的一生，所以你不会察觉。"

"那这一切到底是为了什么？"

"你认真的？"我笑道，"你真要问生命的意义？这不是老生常谈吗？"

"可这问题很自然啊。"你坚持。

我注视着你的眼睛。

"生命的意义、宇宙的目的，是让你成长。"

"你是说人类？你想让我们成长？"

"不，我是说你。整个宇宙，是为你一个人创造的。每一世，你都成长、学习，变得更加智慧与成熟。"

"就我一个？那其他人呢？"

"没有其他人。"我说，"这个宇宙中，只有你和我。"

你呆呆地望着我。

"可地球上那么多人……"

"都是你。你的不同化身。"

"等等，我是每一个人？！"

"你总算明白了。"我笑着拍了拍你的背。

"我是历史上所有人？"

"是的，未来的也是。"

"我是林肯总统？"

"你也是刺杀他的布斯。"

"我是希特勒？"你震惊地问。

"也是他杀害的每一个人。"

"我是耶稣？"

"也是所有信他的人。"

你沉默了。

"你每次伤害别人，其实是在伤害自己。你所有的善行，最终也归于自己。每一个快乐与悲伤的瞬间，都是你经历的部分。"

你沉思了许久。

"为什么？"你问我，"为什么要这样安排？"

"因为有一天，你会变得像我一样。因为这就是你的本质。你是我的孩子。"

"等等……"你不可思议地说道，"我是个神？"

"不，还不是。你现在只是一个胚胎，正在成长的途中。等你活完所有人的生命，你就将成熟，准备出生。"

"那这整个宇宙，其实只是……"

"一个蛋。"我说，"而现在，是时候让你继续你的下一段旅程了。"

我送你踏上新的轮回。`
        }
    ],
    stressed: [
        {
            title: "Lady Killer",
            artist: "G-easy",
            duration: "4:20",
            file: "songs/ladykiller.mp3",
            novel: `一个懦夫：社会称他为"英俊的西尼奥尔"。
他的全名是贡特朗-约瑟夫·德·西尼奥尔子爵。

他是个孤儿，但继承了足够的财产，过得潇洒风光。身材挺拔，仪态不凡，说话得体，甚至可以冒充风趣。他天生优雅，高傲自信，一撮英俊的胡子下藏着一双会说话的眼睛——这些正是女人们喜欢的那种男人。

他在社交场合备受欢迎，是舞会上的宠儿。男人们对他怀有那种带笑的敌意——留给那些魅力逼人的竞争者。他曾卷入过几段风流韵事，传闻足以让人对这个年轻人刮目相看。他生活无忧，身心安泰，生活轻松愉快。他还以剑术出色、枪法更佳而著称。

"等我真要决斗了，"他说，"我会选手枪。那玩意儿我百发百中。"

有一晚，他和两个年轻女士以及她们的丈夫一同去剧院看戏。散场后，他邀请他们去托尔托尼吃冰淇淋。

他们刚坐下不久，西尼奥尔便注意到隔壁桌有个男人正死死盯着其中一位女士看。那女士显得局促不安，低下了头。终于，她低声对丈夫说：

"有个人在看我。我不认识他，你认识吗？"

丈夫抬起头扫了一眼，说：

"完全不认识。"

那女士半是恼怒半是尴尬地说：

"真讨厌！他毁了我这杯冰淇淋的兴致。"

她丈夫耸耸肩：

"别理他。遇到没礼貌的人要是都较真，那咱们可忙不过来了。"

但西尼奥尔一下子站了起来。他不能容忍一个陌生人毁掉他请客的冰淇淋。这既是他请的客，这位女士的尴尬就是对他的冒犯。这事别人无权插手。

他径直走到那男人面前说：

"先生，您看那位女士的方式让我非常不舒服。请您自重。"

那人回了一句：

"闭嘴吧你。"

"当心点，"西尼奥尔咬牙切齿，"你会逼得我失去礼貌的底线。"

那人回答了一个字——一个肮脏、粗俗的字眼，在咖啡馆里回响开来，如同拉开发条的"咔嗒"声，一下子激起了所有人的反应。有的人猛地转过头；有的抬起了眼；三名侍者脚底一转，像陀螺一样回过身来；柜台后的两位女士身体一震，像被同一个发条驱动的木偶转过身去。

接着，是死一般的沉默。突然，一声清脆的响声划破空气——西尼奥尔扇了对方一记耳光。人群立刻站起来劝阻，双方交换了名片。

回到家中，西尼奥尔在房间里来回踱步，步子快而有力。他太激动，根本没法静下心来想事。脑中只有一个念头反复盘旋："决斗！"可他尚未感到恐惧。他不过是做了该做的事，表现得像一个正直的绅士。大家会说他做得对，会称赞他。他喃喃自语：

"那混蛋！"

他坐下来开始思考。第二天一早要找两个"见证人"。该找谁？他回忆起最有声望的熟人，最后决定请拉图尔-努瓦尔侯爵和布尔丹上校，一个是贵族，一个是军人，正合适。他们的名字登报也体面。

他觉得口渴，一口气喝了三大杯水。又开始走动。他充满了精力。他若能表现得果敢坚决，坚持最严格、最危险的决斗条件，也许对方会知难而退。

他捡起了那张名片——他早在咖啡馆里扫过一眼，在回家的马车上每见一盏路灯就又看一眼。名片上写着："乔治·拉米尔，蒙西街51号。"——仅此而已。

他望着那几行字母，仿佛望着谜一样的信息。乔治·拉米尔是谁？干什么的？为什么要那样看那个女士？一个陌生人、一个无名之辈，居然就这样随意地搅乱了一个男人的生活！他又怒气冲冲地说：

"那混蛋！"

他站着不动，盯着那张名片。突然，他对这张纸片生出一种仇恨，那是一种夹杂着焦躁的愤怒。他抓起桌上的一把小刀，猛地刺进印着名字的中间，仿佛刺向那个人的心脏。

他得去决斗。选剑还是选枪？他是被侮辱的一方。用剑风险小，但用枪对方也许会退缩。剑术决斗很少致命，毕竟谁都不愿把剑扎得太深。可用枪，就可能要命，也可能对方打退堂鼓。

"我得强硬点，"他说，"他会害怕的。"

他自己的声音让他发抖。他环顾四周，心里慌乱。他又喝了一杯水，开始脱衣睡觉。

熄了灯，闭上眼睛。

"我还有整整一天来安排一切。现在该睡觉了，这样明天我就能镇定些。"

他窝在温暖的被窝里，却怎么也睡不着。他翻来覆去，仰躺五分钟，换侧，又翻到另一边。

还是口渴。他起身喝水。一种奇怪的不安感爬上心头：

"难道……我是在怕？"

房间里一点熟悉的响动都会让他心跳如雷。钟表的齿轮刚发出微响，他便猛地一震，好一会儿才缓过气来。

他开始理性地分析：我是在害怕吗？

不，不会怕。他已经决定了要决斗，不可能怕。可这份压抑到极点的焦虑又是什么？他怀疑：难道一个人可以在决定无畏的同时，还是控制不住地恐惧？

他陷入了疑虑、焦躁、恐惧的重重包围。要是有一种比他更强大的力量——一种不受控的力量——让他在现场软弱、昏厥呢？他的名誉怎么办？

他忽然想看看镜子中的自己。他点上蜡烛，照镜子。镜中那张脸陌生而苍白，眼睛异常大，他几乎认不出自己。他伸出舌头，仿佛要确认身体状况。忽然，一个念头像子弹一样打进脑海：

"后天这个时候，我可能已经死了。"

心脏又是一阵狂跳。

"我现在看着镜子，活着，可是二十四小时之后，我可能就躺在这张床上，双眼紧闭，四肢冰冷，消失在世界上。"

他转身望向床，仿佛真的看到自己死去后躺在那儿，脸颊凹陷、双手僵硬。

他开始怕那张床了，为了避开这恐惧，他去了吸烟室。本能地拿起一支雪茄，点燃，继续走来走去。他感到寒冷，伸手要拉铃叫仆人，可刚伸手就停住了：

"他会看出我害怕。"

于是他没有拉铃，而是自己点上了火。他的手微微颤抖，触碰到东西就打抖。他的脑子仿佛醉了一样，意识模糊、思绪紊乱。

他反复地想：

"我该怎么办？我怎么了？"

他浑身发抖，牙齿咯咯响。他走到窗前拉开窗帘。

晨曦已经升起，夏天的清晨洒下玫瑰色的光，涂抹在屋顶与墙上。一缕阳光仿佛柔和的手抚摸大地。光明带来了希望，一种突如其来的希望充满他心：

"我这是疯了吗？对方的见证人都还没见，我就吓成这样？"

他洗漱、更衣，迈着坚定的步子出门。

一路上他告诉自己：

"我要果敢果断。我要表现得毫不畏惧。"

侯爵和上校成了他的见证人，他们热情地握手后，讨论决斗条件。

"你希望决斗够认真？"上校问。

"是的，非常认真。"西尼奥尔答。

"还坚持用手枪？"侯爵问。

"是的。"

"其他细节就交给我们处理了？"

西尼奥尔干巴巴地说：

"二十步，听到信号举枪，不许放下，直到有一方重伤为止。"

"很好！"上校满意地说，"你枪法好，赢面大。"

他们走后，西尼奥尔开始等待。他的恐惧又一波波涌上心头。他手脚都在轻微颤抖，胸口发紧，口干舌燥，不停舔嘴唇。他试着吃点早餐，但完全咽不下。他让仆人拿来一瓶朗姆酒，一口气灌下六杯小酒杯。

酒精的热力充满全身，随之而来的却是精神上的更深混乱。

"现在我知道该怎么做了。"他想，"一切都会好的。"

可一个小时后他把酒全喝光，恐惧又来了。他只想在地上打滚、尖叫、咬人。夜幕降临。

门铃响了，他吓得无法站起。连"晚上好"都不敢说，怕一开口就暴露了恐惧。

"都按你的条件办好了，"上校说，"对方原本想争取作为受辱一方的特权，但很快就接受了。他的见证人是两位军人。"

"谢谢。"西尼奥尔说。

"我们得赶紧走，有很多事要安排，"侯爵说，"得请好医生，万一有人中枪。也得选一个附近有房子的场地，好抬人进去。总之有得忙。"

"谢谢。"西尼奥尔又说了一遍。

"你没事吧？"上校问，"冷静吗？"

"很冷静，谢谢。"

两人离开了。

他再次独处，感觉要疯了。仆人点上灯，他坐到桌前写信。写下"这是我的遗嘱"几个字后，浑身发冷，无法继续。

他要决斗了，已无法逃避。可这到底是怎么了？他不是已经下定决心了吗？可不管怎么努力，他知道自己连走到决斗地点的力气都没有。

他试图想象对峙的场面。忽然，他牙齿咯咯响。他拿起一本《决斗守则》翻阅。他想：

"对方常练枪吗？有名气吗？在哪能查到？"

他想到《名枪手录》，翻了个遍，没看到乔治·拉米尔。但对方既然同意手枪和这种致命条件，那他肯定也不是菜鸟吧？

他顺手打开一只手枪盒，取出一把枪，对准前方举起——可他的手在抖，枪口乱晃。

他对自己说：

"不行，这状态根本不能决斗。"

他盯着枪口，那黑洞洞的小口喷吐着死亡。他想到俱乐部里的耳语、沙龙中的嘲笑、女人的鄙夷、报纸上的暗讽、胆小鬼的辱骂……

他继续盯着那把枪，拉动扳机，看见一枚火帽在里面闪着红光。幸运或是疏忽，这把枪竟已上膛。

他突然有一种莫名的喜悦。

如果面对那人时自己不能镇定从容，那就完了。他知道自己做不到那份潇洒。可他是勇敢的——他想决斗。他是勇敢的，因为……

这个念头还没成形，他已经猛地张嘴，将枪口塞入喉咙，狠狠扣下扳机。

仆人听到枪声跑进来时，他已仰面死去。一股鲜血溅到桌上的白纸上，染红了那行字：

"这是我的遗嘱。"`
        }
    ]
};

// Track current state
const state = {
    mood: null,
    song: null,
    isPlaying: false,
    audio: null,
    audioContext: null,
    isLoading: false,
    hasError: false,
    isTransitioning: false
};

// Initialize audio context
function initAudioContext() {
    if (!state.audioContext) {
        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

// Show error message
function showError(message = 'Error loading song. Please try again.') {
    // Don't show error if we're transitioning or playing successfully
    if (state.isTransitioning || (state.isPlaying && !state.hasError)) return;
    
    const errorMessage = document.getElementById('error-message');
    const loadingIndicator = document.getElementById('loading-indicator');
    if (errorMessage) {
        errorMessage.querySelector('span').textContent = message;
        errorMessage.classList.remove('hidden');
        // Auto-hide error message after 3 seconds
        setTimeout(() => {
            errorMessage.classList.add('hidden');
        }, 3000);
    }
    if (loadingIndicator) loadingIndicator.classList.add('hidden');
    state.hasError = true;
}

// Show loading state
function showLoading() {
    state.isLoading = true;
    state.hasError = false;
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessage = document.getElementById('error-message');
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    if (errorMessage) errorMessage.classList.add('hidden');
}

// Hide loading state
function hideLoading() {
    state.isLoading = false;
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) loadingIndicator.classList.add('hidden');
}

// Format time in MM:SS format
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Update play button state
function updatePlayButton() {
    const playButton = document.querySelector('.play-btn');
    if (!playButton) return;
    
    if (state.isPlaying) {
        playButton.innerHTML = '<i class="fas fa-pause"></i>';
    } else {
        playButton.innerHTML = '<i class="fas fa-play"></i>';
    }
}

// Clean up current audio
function cleanupAudio() {
    if (state.audio) {
        state.audio.pause();
        state.audio.currentTime = 0;
        state.audio.src = '';
        state.audio = null;
    }
    state.isPlaying = false;
    state.hasError = false;
    updatePlayButton();
}

// Get music based on mood
async function getMusic(mood) {
    try {
        // Don't start new loading if we're already loading or transitioning
        if (state.isLoading || state.isTransitioning) return;
        
        // Set transitioning state
        state.isTransitioning = true;
        
        // Initialize audio context
        initAudioContext();
        
        // Update state
        state.mood = mood;
        const songs = moodMusic[mood];
        if (!songs || songs.length === 0) {
            throw new Error('No songs available for this mood');
        }
        
        state.song = songs[Math.floor(Math.random() * songs.length)];
        
        // Show loading state
        showLoading();
        
        // Update UI with song info
        const songTitle = document.getElementById('song-title');
        const artistName = document.getElementById('artist-name');
        const songDuration = document.getElementById('song-duration');
        const musicContainer = document.getElementById('music-container');
        
        if (songTitle) songTitle.textContent = state.song.title;
        if (artistName) artistName.textContent = state.song.artist;
        if (songDuration) songDuration.textContent = state.song.duration;
        if (musicContainer) musicContainer.classList.remove('hidden');
        
        // Update novel content
        const novelContainer = document.getElementById('novel-container');
        const novelContent = document.querySelector('#novel-content p');
        if (novelContent) novelContent.textContent = state.song.novel;
        
        // Update novel titles based on mood
        const titles = document.querySelectorAll('#novel-container h2');
        titles.forEach(title => {
            title.classList.add('hidden');
            title.style.display = 'none';
        });
        
        const titleMap = {
            happy: { index: 0, text: '盐水记忆' },
            sad: { index: 1, text: 'life,once again!' },
            tired: { index: 2, text: '蛋' },
            stressed: { index: 3, text: '一个懦夫' }
        };
        
        const titleInfo = titleMap[mood];
        if (titleInfo && titles[titleInfo.index]) {
            titles[titleInfo.index].textContent = titleInfo.text;
            titles[titleInfo.index].classList.remove('hidden');
            titles[titleInfo.index].style.display = 'block';
        }
        
        if (novelContainer) {
            novelContainer.classList.remove('hidden');
            // Update grid layout based on visible title
            const gridContainer = novelContainer.querySelector('.grid');
            if (gridContainer) {
                gridContainer.style.gridTemplateColumns = '1fr';
            }
        }
        
        // Clean up previous audio
        cleanupAudio();
        
        // Create new audio element
        state.audio = new Audio();
        
        // Set up audio event listeners
        state.audio.addEventListener('canplaythrough', () => {
            hideLoading();
            state.audio.play().catch(error => {
                console.error('Error playing audio:', error);
                // Only show error if it's not a user interaction error
                if (error.name !== 'NotAllowedError') {
                    showError('Error playing audio. Please try again.');
                }
            });
            state.isPlaying = true;
            state.hasError = false;
            state.isTransitioning = false;
            if (musicContainer) musicContainer.classList.add('playing');
            updatePlayButton();
        });
        
        state.audio.addEventListener('error', (e) => {
            console.error('Audio error:', e);
            // Only show error for actual loading failures
            if (e.target.error && e.target.error.code === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                hideLoading();
                showError('Error loading audio file. Please try again.');
                state.isPlaying = false;
                state.hasError = true;
                state.isTransitioning = false;
                updatePlayButton();
            }
        });
        
        state.audio.addEventListener('timeupdate', () => {
            // If we're playing successfully, clear any error state
            if (state.isPlaying && !state.hasError) {
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) errorMessage.classList.add('hidden');
            }
            
            const progressBar = document.getElementById('progress-bar');
            const currentTime = document.querySelector('.current-time');
            
            if (progressBar && state.audio.duration) {
                const progress = (state.audio.currentTime / state.audio.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
            
            if (currentTime) {
                currentTime.textContent = formatTime(state.audio.currentTime);
            }
        });
        
        state.audio.addEventListener('ended', () => {
            state.isPlaying = false;
            state.hasError = false;
            state.isTransitioning = false;
            if (musicContainer) musicContainer.classList.remove('playing');
            updatePlayButton();
        });
        
        state.audio.addEventListener('loadedmetadata', () => {
            const duration = formatTime(state.audio.duration);
            if (songDuration) songDuration.textContent = duration;
        });
        
        // Set source and load audio
        state.audio.src = state.song.file;
        state.audio.load();
        
    } catch (error) {
        console.error('Error in getMusic:', error);
        showError(error.message || 'An error occurred. Please try again.');
        cleanupAudio();
        state.isTransitioning = false;
    }
}

// Add event listeners for music controls
document.addEventListener('DOMContentLoaded', () => {
    const playButton = document.querySelector('.play-btn');
    
    if (playButton) {
        playButton.addEventListener('click', () => {
            if (!state.audio || state.isTransitioning) return;
            
            if (state.isPlaying) {
                state.audio.pause();
                state.isPlaying = false;
            } else {
                state.audio.play().catch(error => {
                    console.error('Error playing audio:', error);
                    if (error.name !== 'NotAllowedError') {
                        showError('Error playing audio. Please try again.');
                    }
                });
                state.isPlaying = true;
            }
            
            const musicContainer = document.getElementById('music-container');
            if (musicContainer) musicContainer.classList.toggle('playing');
            updatePlayButton();
        });
    }
    
    // Enable seeking by clicking on the progress bar
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    if (progressBarContainer && progressBar) {
        progressBarContainer.addEventListener('click', (e) => {
            if (!state.audio || !state.audio.duration) return;
            const rect = progressBarContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percent = Math.max(0, Math.min(1, x / rect.width));
            state.audio.currentTime = percent * state.audio.duration;
        });
    }

    // Add error handling for audio context
    window.addEventListener('click', () => {
        if (state.audioContext && state.audioContext.state === 'suspended') {
            state.audioContext.resume();
        }
    });
}); 